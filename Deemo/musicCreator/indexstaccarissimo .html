<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <script src="mainstaccarissimo.js"></script>
</head>
<body>
  <script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
  <script>
    var app = Elm.MusicCreator.init();
    const AudioContextFunc = window.AudioContext || window.webkitAudioContext
    const audioContext = new AudioContextFunc()
    const player = new WebAudioFontPlayer()
    var envelope=null;

    app.ports.play.subscribe(function (music) {
      const info = player.loader.instrumentInfo(music.instrument)
      player.loader.startLoad(audioContext, info.url, info.variable)

      player.loader.waitLoad(function () {
        player.cancelQueue(audioContext)

        const startTime = audioContext.currentTime + 0.2

        music.events.forEach(function (event) {
          const time = startTime + event.time
          console.log(event.volume)

          player.queueWaveTable(
            audioContext,
            audioContext.destination,
            window[info.variable],
            time,
            event.pitch,
            (event.duration * 0.25),
            event.volume,
          )
          player.queueWaveTable(
            audioContext,
            audioContext.destination,
            window[info.variable],
            time,
            event.pitch,
            event.duration,
            -1,
          )
        })
      })

      return false 
    })

  </script>
</body>
</html>
